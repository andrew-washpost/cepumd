---
output: github_document
---

[![CRAN status](https://cran.r-project.org/package=cepumd)](https://www.r-pkg.org/badges/version/cepumd)

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE,
  warning = FALSE
)
```
# cepumd

`cepumd` facilitates the calculation of Consumer Expenditure Survey (CE) annual, weighted, estimated mean expenditures using CE Public-Use Microdata (PUMD) by addressing some unique challenges that exist in working with CE PUMD. Some examples are:

* Downloading CE PUMD from within R
* Converting stub files to data tables
* Accounting for the factor (annual vs. quarterly expenditure)
* Accounting for the "months in scope" of a given consumer unit (CU)
* Annualizing expenditures for either Diary or Interview expenditures
* Integrating Interview and Diary data as necessary
* Calculating weighted CE medians

There are 4 functions that help the user download and wrangle the data and necessary documentation, such as the stub files:

* `ce_download()` downloads zip files for a given year and survey instrument directly from the CE website
* `ce_stub()` pulls the requested type of stub file (Interview, Diary, or Integrated) for a specified year.
* `ce_uccs()` collects the Universal Classification Codes (UCC) for a specified type of expenditure from a specified stub file.
* `ce_prepdata` merges the household characteristics file (FMLI/-D) with the corresponding expenditure tabulation file (MTBI/EXPD) for a specified year, adjusts weights for months-in-scope and the number of collection quarters, adjusts some cost values by their periodicity factor (some cost categories are represented as annual figures and others as quarterly).

There are 2 functions that the user can use to calculate CE summary statistics:

* `ce_mean()` calculates a mean expenditure, standard error of the mean, coefficient of variation, and an aggregate expenditure.

* `ce_median()` calculates a median expenditure. It is important to note that calculating means for integrated expenditures is not recommended because the calculation involves using weights from both the Diary and Survey instruments.

## Installation

You can install the released version of `cepumd` from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("cepumd")
```

## Example Workflow

The following is an example of how someone might go about using `cepumd` to calculate a 2017 annual, weighted estimate of mean expenditures on pets using CE integrated data.

The first step is to find out what UCC's represent the detailed expenditure categories that make up pet expenditures by downloading the stub and reviewing those categories.

```{r, read_stub}
# install.packages(c("cepumd", "dplyr", "tidyr", "purrr", "ggplot2"))
library(cepumd)
library(dplyr)

pet_stub <- ce_stub(2017, integrated)

pet_stub %>% slice(grep("[P|p]ets", pet_stub$title))
```

We see that there are two categories containing the word "Pets,", though the "level" column indicates that "Pets", level 4, falls under "Pets, toys, hobbies, and playground equipment," level 3. We're only interested strictly in "Pet" expenditures and not toys, hobbies, or playground equipment.

```{r, view_uccs}
pet_uccs <- ce_uccs(pet_stub, "Pets")
pet_uccs

pet_stub %>% filter(ucc %in% pet_uccs)
```

We can see that there are 4 detailed expenditure categories under the category of pet expenditures. Next we'll want to prepare a dataset to calculate an integrated weighted mean expenditure estimate. To do that, though, we'll need both the Diary and Interview data for pet expenditures. We will include the "bls_urbn" variable to calculate estimated means by group later.

```{r, prep_data, echo = TRUE, results = 'hide', message = FALSE, warning = FALSE}
pet_int <- ce_prepdata(
  year = 2017, survey = interview, uccs = pet_uccs, zp = NULL, 
  integrate_data = TRUE, stub = pet_stub, bls_urbn
)

pet_dia <- ce_prepdata(
  year = 2017, survey = diary, uccs = pet_uccs, zp = NULL, 
  integrate_data = TRUE, stub = pet_stub, bls_urbn
)

pet_integrated <- bind_rows(pet_int, pet_dia)
```

The Interview and Diary datasets have each been prepared and combined. Next we'll calculate estimated, weighted, mean pet expenditures for 2017.

```{r, calc_means}
pet_mean <- ce_mean(pet_integrated)
knitr::kable(pet_mean)
```

The median expenditure on pets We can also calculate estimated, weighted, means by group. In this case we'll use the bls_urbn variable. We'll also generate a plot of the those means.
```{r, calc_means_by_urbn}
pet_mean_by_urbn <- pet_integrated %>%
  group_by(bls_urbn) %>%
  tidyr::nest() %>%
  mutate(
    ce_mn_df = purrr::map(data, ce_mean),
    bls_urbn = ifelse(bls_urbn %in% 1, "Urban", "Rural")
  ) %>% 
  select(-data) %>% 
  tidyr::unnest(ce_mn_df) %>%
  mutate(
    lower = mean_exp - (qnorm(0.975) * se),
    upper = mean_exp + (qnorm(0.975) * se)
  )

knitr::kable(pet_mean_by_urbn)

library(ggplot2)

ggplot(pet_mean_by_urbn, aes(x = bls_urbn, y = mean_exp, fill = bls_urbn)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.8) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.4) +
  theme_light() +
  theme(title = element_text(hjust = 0.5)) +
  labs(
    title = "2017 estimated mean pet expenditures by urbanicity",
    x = "Urbanicity",
    y = "Estimated mean expenditure ($)",
    fill = "Urbanicity"
  )
```

We can also calculate estimated, weighted median expenditures. Because the integrated data come from both the Interview and Diary surveys, we'll display them by UCC.
```{r calc_median}
pet_mean_by_ucc <- pet_integrated %>%
  group_by(ucc) %>%
  tidyr::nest() %>%
  mutate(ce_med_df = purrr::map(data, ce_median)) %>% 
  select(-data) %>% 
  tidyr::unnest(ce_med_df)

knitr::kable(pet_mean_by_ucc)
```
