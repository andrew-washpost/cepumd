---
output: github_document
---

[![Travis build status](https://travis-ci.com/arcenis-r/cepumd.svg?branch=master)](https://travis-ci.com/arcenis-r/cepumd)
[![Codecov test coverage](https://codecov.io/gh/arcenis-r/cepumd/branch/master/graph/badge.svg)](https://codecov.io/gh/arcenis-r/cepumd?branch=master)

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE,
  warning = FALSE
)
```

# cepumd

`cepumd` facilitates the calculation of Consumer Expenditure Survey (CE) annual, weighted, estimated mean expenditures using CE Public-Use Microdata (PUMD) by addressing some unique challenges that exist in working with CE PUMD. Some examples are:

* Downloading CE PUMD from within R
* Converting stub files to data tables
* Accounting for the factor (annual vs. quarterly expenditure)
* Accounting for the "months in scope" of a given consumer unit (CU)
* Annualizing expenditures for either Diary or Interview expenditures
* Integrating Interview and Diary data as necessary
* Calculating weighted CE quantiles

There are 4 functions that help the user download and wrangle the data and necessary documentation, such as the stub files:

* `ce_download()` downloads zip files for a given year and survey instrument directly from the CE website
* `ce_stub()` pulls the requested type of stub file (Interview, Diary, or Integrated) for a specified year.
* `ce_uccs()` filters the stub file for the specified expenditure category and returns either a data frame with only that section of the stub file or the Universal Classification Codes (UCCs) that make up that expenditure category.
* `ce_prepdata` merges the household characteristics file (FMLI/-D) with the corresponding expenditure tabulation file (MTBI/EXPD) for a specified year, adjusts weights for months-in-scope and the number of collection quarters, adjusts some cost values by their periodicity factor (some cost categories are represented as annual figures and others as quarterly).

There are 2 functions that the user can use to calculate CE summary statistics:

* `ce_mean()` calculates a mean expenditure, standard error of the mean, coefficient of variation, and an aggregate expenditure.

* `ce_quantiles()` calculates weighted expenditure quantiles. It is important to note that calculating means for integrated expenditures is not recommended because the calculation involves using weights from both the Diary and Survey instruments.

## Installation

You can install the development version of `cepumd` from [GitHub](https://github.com) with:

```{r, get_cepumd, eval=FALSE}
devtools::install_github("/arcenis-r/cepumd")
```

## Example Workflow

The following is an example of how someone might go about using `cepumd` to calculate a 2017 annual, weighted estimate of mean expenditures on pets using CE integrated data.

The first step is to load the necessary packages into the environment.

```{r, load_pkgs}

# Store a vector of names of packages to be used
pkgs <- c("dplyr", "tidyr", "purrr", "ggplot2", "devtools")

# Install packages from CRAN
sapply(pkgs, function(x) if (!x %in% installed.packages()) install.packages(x))

# Load 'cepumd' and 'dplyr' to the workspace
library(cepumd)
library(dplyr)
```

Next we'll find out what titles in the stub contain the word "Pets."

```{r, read_stub}
# Download the stub file
stub_file <- ce_stub(2017, integrated)

# Pull out the titles that contain the word "Pets"
stub_file %>%
  slice(grep("[P|p]ets", title)) %>%
  knitr::kable(booktabs = TRUE)
```

We see that there are two categories containing the word "Pets,", though the "level" column indicates that "Pets", level 4, falls under "Pets, toys, hobbies, and playground equipment," level 3. We're only interested strictly in "Pet" expenditures and not toys, hobbies, or playground equipment.

Now we can look at the section of the stub file containing the UCC's that make up pet expenditures with `ce_uccs()`.

```{r, get_pet_stub}
# Filter the stub file for pet related UCCs
pet_stub <- ce_uccs(stub_file, "Pets", uccs_only = FALSE)
```

```{r, show_stub, echo=FALSE}
pet_stub %>%
  knitr::kable(booktabs = TRUE)
```

Next we'll want to prepare a dataset to calculate an integrated weighted mean expenditure estimate. To do that, though, we'll need both the Diary and Interview data for pet expenditures. We will include the "bls_urbn" variable to calculate estimated means by group later.

```{r, prep_data, echo = TRUE, results = 'hide', message = FALSE, warning = FALSE}
pets_interview <- ce_prepdata(
  year = 2017, 
  survey = interview, 
  uccs = ce_uccs(pet_stub, "Pets", uccs_only = TRUE),
  zp = NULL, 
  integrate_data = TRUE, 
  stub = pet_stub, 
  bls_urbn
)

pets_diary <- ce_prepdata(
  year = 2017, 
  survey = diary, 
  uccs = ce_uccs(pet_stub, "Pets", uccs_only = TRUE), 
  zp = NULL, 
  integrate_data = TRUE,
  stub = pet_stub,
  bls_urbn
)

pets_integrated <- bind_rows(pets_interview, pets_diary)
```

The Interview and Diary datasets have each been prepared and combined. Next we'll calculate estimated, weighted, mean pet expenditures for 2017.

```{r, calc_means}
pet_mean <- ce_mean(pets_integrated)
```

```{r, show_means, echo=FALSE}
knitr::kable(pet_mean, booktabs = TRUE)
```

We can also calculate estimated, weighted, means by group. In this case we'll use the "bls_urbn" variable.
```{r, calc_means_by_urbn}
pet_mean_by_urbn <- pets_integrated %>%
  group_by(bls_urbn) %>%
  tidyr::nest() %>%
  mutate(
    ce_mn_df = purrr::map(data, ce_mean),
    bls_urbn = ifelse(bls_urbn %in% 1, "Urban", "Rural")
  ) %>% 
  select(-data) %>% 
  tidyr::unnest(ce_mn_df) %>%
  mutate(
    lower = mean_exp - (qnorm(0.975) * se),
    upper = mean_exp + (qnorm(0.975) * se)
  )
```

```{r, show_pet_mean_by_urbn, echo=FALSE}
knitr::kable(pet_mean_by_urbn, booktabs = TRUE)
```

We'll also generate a plot of the those means.

```{r, plot_pet_means}
library(ggplot2)

ggplot(pet_mean_by_urbn, aes(x = bls_urbn, y = mean_exp, fill = bls_urbn)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.8) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.4) +
  theme_light() +
  theme(title = element_text(hjust = 0.5)) +
  labs(
    title = "2017 estimated mean pet expenditures by urbanicity",
    x = "Urbanicity",
    y = "Estimated mean expenditure ($)",
    fill = "Urbanicity"
  )
```

We can also calculate weighted quantiles. Because the integrated data come from both the Interview and Diary surveys, we'll get Interview data without preparing it for integration to look at only Interview survey medians. We'll look at the 25%, 50%, 75%, 90%, and 95% quantiles.
```{r calc_quantiles}
pets_interview_only <- ce_prepdata(
  year = 2017, 
  survey = interview, 
  uccs = ce_uccs(pet_stub, "Pets", uccs_only = TRUE),
  zp = NULL, 
  integrate_data = FALSE, 
  stub = pet_stub, 
  bls_urbn
)

pet_quantiles_by_urbn <- pets_interview_only %>%
  tidyr::nest(-bls_urbn) %>%
  mutate(
    ce_quant_df = purrr::map(data, ce_quantiles, c(0.25, 0.5, 0.75, 0.9, 0.95))
  ) %>% 
  select(-data) %>% 
  tidyr::unnest(ce_quant_df)
```

```{r, show_quantiles, echo=FALSE}
knitr::kable(pet_quantiles_by_urbn)
```
